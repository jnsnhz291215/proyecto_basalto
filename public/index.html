<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Calendario de Turnos</title>
  <link rel="stylesheet" href="style.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <script src="navbar.js"></script>
</head>
<body>
  <!-- Shared menu will be injected here -->
  <div id="shared-menu-placeholder"></div>
  <script>
    fetch('menu.html').then(r => r.text()).then(html => {
      const wrapper = document.createElement('div');
      wrapper.innerHTML = html;
      document.body.insertBefore(wrapper, document.body.firstChild);
      // Inicializar comportamiento del menú (toggle y link activo)
      const btn = wrapper.querySelector('#nav-toggle');
      const items = wrapper.querySelector('#nav-items');
      if (btn && items) btn.addEventListener('click', () => items.classList.toggle('show'));
      // marcar link activo
      try{
        const links = wrapper.querySelectorAll('.nav-item a');
        links.forEach(a=>{ if (location.pathname.endsWith(a.getAttribute('href'))) a.classList.add('active'); });
      }catch(e){}
      // Inicializar dropdown de usuario (toggle + click outside)
      try {
        const userToggle = wrapper.querySelector('.user-toggle');
        const userMenu = wrapper.querySelector('.user-menu');
        if (userToggle && userMenu) {
          userToggle.addEventListener('click', (ev) => { ev.stopPropagation(); userMenu.classList.toggle('show'); userToggle.setAttribute('aria-expanded', userMenu.classList.contains('show')); });
          document.addEventListener('click', (ev) => { if (!userMenu.contains(ev.target) && !userToggle.contains(ev.target)) { userMenu.classList.remove('show'); userToggle.setAttribute('aria-expanded', 'false'); } });
        }
        
                // Menu hamburguesa en móvil
                const navToggle = wrapper.querySelector('#nav-toggle');
                const navItems = wrapper.querySelector('#nav-items');
                const navRight = wrapper.querySelector('#usuario-container');
                if (navToggle && navItems) {
                  navToggle.addEventListener('click', () => {
                    navItems.classList.toggle('show');
                    if (navRight) navRight.classList.toggle('show');
                  });
                  // Cerrar menú cuando se hace click en un link
                  const navLinks = navItems.querySelectorAll('a');
                  navLinks.forEach(link => {
                    link.addEventListener('click', () => {
                      navItems.classList.remove('show');
                      if (navRight) navRight.classList.remove('show');
                    });
                  });
                }
        
        const logoutBtn = wrapper.querySelector('.user-menu .danger');
        if (logoutBtn) logoutBtn.addEventListener('click', (ev) => { ev.preventDefault(); localStorage.removeItem('usuarioActivo'); window.location.href = '/index.html'; });
        // Actualizar nombre de usuario si existe sesión
        try {
          const s = localStorage.getItem('usuarioActivo');
          if (s) {
            const u = JSON.parse(s);
            const nameEl = wrapper.querySelector('.user-name'); if (nameEl && u && u.nombre) nameEl.textContent = u.nombre;
          }
        } catch(e){}
      } catch(e){}
      // Actualizar interfaz ahora que el menú está inyectado
      try { if (window.actualizarInterfaz) window.actualizarInterfaz(); } catch(e){}
    }).catch(err => console.error('No se pudo cargar el menú:', err));
  </script>
  <div class="container">
    <!-- (botones laterales eliminados: ahora usar menú superior) -->

    <!-- Contenido principal -->
    <div class="main-content">
      <!-- Header del calendario -->
      <div class="calendar-header">
        <h1 id="month-year">Enero 2026</h1>
        <div class="header-controls">
          <button id="prev-month" class="nav-arrow">←</button>
          <button id="next-month" class="nav-arrow">→</button>
          <button id="btn-hoy" class="btn-today">Volver a hoy (<span id="fecha-hoy">19/01/2026</span>)</button>
        </div>
      </div>

      <!-- Calendario -->
      <div class="calendar-responsive-wrapper">
        <div class="calendar-wrapper">
          <div class="weekdays">
            <div>Lunes</div>
            <div>Martes</div>
            <div>Miércoles</div>
            <div>Jueves</div>
            <div>Viernes</div>
            <div>Sábado</div>
            <div>Domingo</div>
          </div>
          <div id="days-grid" class="days-grid"></div>
        </div>
      </div>
    </div>

    <!-- Referencia de grupos -->
    <div class="sidebar-right">
      <div class="referencia">
        <h3>Referencia</h3>
        <div id="grupos-leyenda"></div>
      </div>
    </div>
  </div>

  <!-- Modal de detalle del día -->
  <div id="day-modal" class="modal">
    <div class="modal-content">
      <span class="close-modal">&times;</span>
      <h2 id="modal-date-title">Detalle del día</h2>
      <div id="modal-date-subtitle"></div>
      <div id="trabajadores-del-dia" class="trabajadores-list"></div>
    </div>
  </div>

  <!-- Dual login modal: usuario / administrador -->
  <div id="dual-login-modal" class="modal">
    <div class="modal-content" style="max-width:900px;display:flex;gap:20px;flex-wrap:wrap;justify-content:center;padding:22px">
      <div class="login-card" style="flex:1;min-width:280px;max-width:420px">
        <div class="login-header">
          <div class="security-icon"><i class="fa-solid fa-user"></i></div>
          <h2 class="login-title">Ingresar como Usuario</h2>
          <p class="login-subtitle">Accede a tus datos personales</p>
        </div>
        <form id="user-login-form">
          <div class="form-group">
            <label>Usuario</label>
            <div class="input-wrapper">
              <i class="fa-solid fa-user input-icon"></i>
              <input id="user-rut" type="text" placeholder="Ej: JuanPerez" class="modern-input">
            </div>
          </div>
          <div class="form-group">
            <label>Contraseña</label>
            <div class="input-wrapper">
              <i class="fa-solid fa-lock input-icon"></i>
              <input id="user-pass" type="password" placeholder="Tu clave" class="modern-input">
            </div>
          </div>
          <div class="login-actions">
            <button id="btn-user-login" type="submit" class="btn-login-primary">Ingresar como usuario</button>
          </div>
        </form>
      </div>

      <div class="login-card admin-login" style="flex:1;min-width:280px;max-width:420px">
        <div class="login-header">
          <div class="security-icon"><i class="fa-solid fa-user-shield"></i></div>
          <h2 class="login-title">Ingresar como Admin</h2>
          <p class="login-subtitle">Área de administración</p>
        </div>
        <form id="admin-login-form">
          <div class="form-group">
            <label>RUT</label>
            <div class="input-wrapper">
              <i class="fa-solid fa-id-badge input-icon"></i>
              <input id="admin-rut" type="text" placeholder="RUT sin puntos" class="modern-input">
            </div>
          </div>
          <div class="form-group">
            <label>Contraseña</label>
            <div class="input-wrapper">
              <i class="fa-solid fa-key input-icon"></i>
              <input id="admin-pass" type="password" placeholder="••••••" class="modern-input">
            </div>
          </div>
          <div class="login-actions" style="display:flex;gap:10px">
            <button id="btn-admin-login" type="submit" class="btn-admin btn-login-primary">Acceder</button>
            <button id="btn-skip-login" type="button" class="btn-cancel">Entrar sin logear</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- Modal de confirmación -->
  <div id="confirm-modal" class="confirm-modal">
    <div class="confirm-modal-content">
      <h3 id="confirm-title">Confirmar acción</h3>
      <p id="confirm-message">¿Está seguro de realizar esta acción?</p>
      <div class="confirm-modal-buttons">
        <button id="confirm-cancel" class="confirm-btn confirm-btn-secondary">Cancelar</button>
        <button id="confirm-ok" class="confirm-btn confirm-btn-danger">Confirmar</button>
      </div>
    </div>
  </div>

  <script type="module" src="app.js"></script>
  <script>
    // Dual login handlers: basic fetch to server endpoints if available
    document.addEventListener('DOMContentLoaded', () => {
      const dualModal = document.getElementById('dual-login-modal');
      // show modal automatically if no active session
      try {
        const s = localStorage.getItem('usuarioActivo');
        if (!s) { if (dualModal) dualModal.classList.add('show'); } else { if (dualModal) dualModal.classList.remove('show'); }
      } catch(e) {}

      // user login
      const userForm = document.getElementById('user-login-form');
      userForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const rut = document.getElementById('user-rut').value.trim();
        const password = document.getElementById('user-pass').value.trim();
        try {
          const res = await fetch('/login', { method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify({ rut, password }) });
          if (res.ok) {
            // persist session and redirect to perfil
            try { localStorage.setItem('usuarioActivo', JSON.stringify({ rol: 'user', nombre: rut })); } catch(e){}
            if (dualModal) dualModal.classList.remove('show');
            window.location.href = '/datos.html';
          } else {
            alert('Error de login de usuario');
          }
        } catch (err) { alert('No fue posible contactar al servidor.'); }
      });

      // admin login
      const adminForm = document.getElementById('admin-login-form');
      adminForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const rut = document.getElementById('admin-rut').value.trim();
        const password = document.getElementById('admin-pass').value.trim();
        try {
          const res = await fetch('/admin-login', { method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify({ rut, password }) });
          if (res.ok) {
            try { localStorage.setItem('usuarioActivo', JSON.stringify({ rol: 'admin', nombre: rut })); } catch(e){}
            if (dualModal) dualModal.classList.remove('show');
            window.location.href = '/gestionar.html';
          } else {
            alert('Credenciales de administrador incorrectas');
          }
        } catch (err) { alert('No fue posible contactar al servidor.'); }
      });

      // skip login
      document.getElementById('btn-skip-login').addEventListener('click', () => {
        if (dualModal) dualModal.classList.remove('show');
      });
    });
  </script>
</body>
</html>
