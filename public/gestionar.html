<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Gestionar Trabajadores</title>
  <link rel="stylesheet" href="style.css">
  <link rel="stylesheet" href="styleg.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <script src="navbar.js"></script>
  <style>
    /* Asegurar que la p√°gina gestionar tenga el mismo font que las otras vistas */
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { background-color: #f3f4f6; font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; color: #1f2937; padding: 20px; margin: 0; }
  </style>
</head>
<body>
  <!-- Shared menu will be injected here -->
  <div id="shared-menu-placeholder"></div>
  <script>
    fetch('menu.html').then(r => r.text()).then(html => {
      const wrapper = document.createElement('div');
      wrapper.innerHTML = html;
      document.body.insertBefore(wrapper, document.body.firstChild);
      // Inicializar men√∫ (toggle y activo)
      const btn = wrapper.querySelector('#nav-toggle');
      const items = wrapper.querySelector('#nav-items');
      if (btn && items) btn.addEventListener('click', () => items.classList.toggle('show'));
      try{ const links = wrapper.querySelectorAll('.nav-item a'); links.forEach(a=>{ if (location.pathname.endsWith(a.getAttribute('href'))) a.classList.add('active'); }); }catch(e){}
      // Menu hamburguesa en m√≥vil: toggle nav-items y nav-right
      if (btn && items) {
        btn.addEventListener('click', () => {
          items.classList.toggle('show');
          const navRight = wrapper.querySelector('#usuario-container');
          if (navRight) navRight.classList.toggle('show');
        });
        const navLinks = items.querySelectorAll('a');
        navLinks.forEach(link => {
          link.addEventListener('click', () => {
            items.classList.remove('show');
            const navRight = wrapper.querySelector('#usuario-container');
            if (navRight) navRight.classList.remove('show');
          });
        });
      }
      // usuario dropdown + session visibility
      try {
        const userToggle = wrapper.querySelector('.user-toggle');
        const userMenu = wrapper.querySelector('.user-menu');
        if (userToggle && userMenu) {
          userToggle.addEventListener('click', (ev) => { ev.stopPropagation(); userMenu.classList.toggle('show'); userToggle.setAttribute('aria-expanded', userMenu.classList.contains('show')); });
          document.addEventListener('click', (ev) => { if (!userMenu.contains(ev.target) && !userToggle.contains(ev.target)) { userMenu.classList.remove('show'); userToggle.setAttribute('aria-expanded', 'false'); } });
        }
        const logoutBtn = wrapper.querySelector('.user-menu .danger');
        if (logoutBtn) logoutBtn.addEventListener('click', (ev) => { ev.preventDefault(); localStorage.removeItem('usuarioActivo'); window.location.href = '/index.html'; });
        // session handling: hide user dropdown if no session, show gestionar only for admin
        try {
          const s = localStorage.getItem('usuarioActivo');
          const navGest = wrapper.querySelector('#nav-gestionar');
          const navRight = wrapper.querySelector('.nav-right');
          if (!s) {
            if (navRight) navRight.style.display = 'none';
            if (navGest) navGest.style.display = 'none';
          } else {
            const u = JSON.parse(s);
            const nameEl = wrapper.querySelector('.user-name'); if (nameEl && u && u.nombre) nameEl.textContent = u.nombre;
            if (navRight) navRight.style.display = '';
            if (navGest) navGest.style.display = (u && u.rol === 'admin') ? '' : 'none';
          }
        } catch(e){}
      } catch(e){}
      // update interface now that menu is injected
      try { if (window.actualizarInterfaz) window.actualizarInterfaz(); } catch(e){}
    }).catch(err => console.error('No se pudo cargar el men√∫:', err));
  </script>

  <!-- Modal de login (admin) - Zona Restringida -->
  <div id="modal-login" class="modal">
    <div class="login-card admin-login">
      <div class="login-header">
        <div class="security-icon"><i class="fa-solid fa-user-shield"></i></div>
        <h2 class="login-title">Acceso a Gestionar</h2>
        <p class="login-subtitle">√Årea restringida para operadores y administradores</p>
      </div>

      <form id="form-login">

        <div class="form-group">
          <label>Usuario Administrador</label>
          <div class="input-wrapper">
            <i class="fa-solid fa-id-badge input-icon"></i>
            <input type="text" id="rut-login" name="rut" placeholder="RUT sin puntos" class="modern-input" autocomplete="off" required>
          </div>
        </div>

        <div class="form-group">
          <label>Contrase√±a</label>
          <div class="input-wrapper">
            <i class="fa-solid fa-key input-icon"></i>
            <input type="password" id="pass-login" name="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" class="modern-input" autocomplete="off" required>
          </div>
        </div>

        <div class="login-actions">
          <button type="submit" class="btn-login-primary btn-admin">
            <i class="fa-solid fa-unlock"></i> Acceder
          </button>

          <div class="secondary-actions" style="margin-top:10px">
            <button type="button" class="btn-text btn-cancel" onclick="location.href='index.html'">Volver al inicio</button>
          </div>
        </div>

      </form>
    </div>
  </div>

  <div class="gestionar-container">
    <!-- Header con controles -->
    <header class="gestionar-header">
      <button id="btn-agregar" class="btn btn-agregar">Agregar trabajador</button>
      <a id="btn-descargar" class="btn btn-primary" href="/reporte_trabajadores.php">Descargar Trabajadores</a>
      <input type="text" id="input-buscar" class="input-buscar" placeholder="Buscar" autocomplete="off">
      <div class="filtro-wrap">
        <label for="select-filtro">Filtrar:</label>
        <select id="select-filtro">
          <option value="">Todos los grupos</option>
          <option value="A">Grupo A</option>
          <option value="B">Grupo B</option>
          <option value="C">Grupo C</option>
          <option value="D">Grupo D</option>
          <option value="E">Grupo E</option>
          <option value="F">Grupo F</option>
          <option value="G">Grupo G</option>
          <option value="H">Grupo H</option>
          <option value="J">Grupo J</option>
          <option value="K">Grupo K</option>
        </select>
      </div>
    </header>

    <!-- √Årea de columnas por grupo (scroll horizontal) -->
    <div class="grupos-scroll">
      <div id="grupos-columnas" class="grupos-columnas"></div>
    </div>
  </div>

  <!-- Modal editar trabajador -->
  <div id="modal-editar" class="modal">
    <div class="modal-content modal-card">
      <div class="modal-header">
        <h3 class="modal-title">
          <i class="fa-solid fa-user-pen highlight-icon"></i> Editar Trabajador
        </h3>
      </div>
      <div class="modal-body">
        <form id="form-editar">
          <div class="form-section-label">Informaci√≥n Personal</div>
          <div class="form-grid">
            <div class="form-group">
              <label for="edit-nombre">Nombres</label>
              <div class="input-wrapper">
                <i class="fa-regular fa-user input-icon"></i>
                <input type="text" id="edit-nombre" name="nombre" placeholder="Ej: Juan Andr√©s" class="modern-input" required>
              </div>
            </div>
            <div class="form-group">
              <label for="edit-apellido">Apellidos</label>
              <input type="text" id="edit-apellido" name="apellido" placeholder="Ej: P√©rez Gonz√°lez" class="modern-input plain" required>
            </div>
            <div class="form-group">
              <label for="edit-rut">RUT <span class="info-text">(sin puntos)</span></label>
              <div class="input-wrapper">
                <i class="fa-solid fa-id-card input-icon"></i>
                <input type="text" id="edit-rut" name="rut" placeholder="12345678-9" class="modern-input" required readonly>
              </div>
            </div>
            <div class="form-group">
              <label for="edit-telefono">Tel√©fono</label>
              <div class="phone-input-group">
                <span class="country-code">üá®üá± +56</span>
                <input type="tel" id="edit-telefono" name="telefono" placeholder="9 1234 5678" class="modern-input" maxlength="9">
              </div>
            </div>
            <div class="form-group full-width">
              <label for="edit-email">Correo Electr√≥nico</label>
              <div class="input-wrapper">
                <i class="fa-regular fa-envelope input-icon"></i>
                <input type="email" id="edit-email" name="email" placeholder="nombre@correo.com" class="modern-input">
              </div>
            </div>
          </div>
          <div class="separator-line"></div>
          <div class="form-section-label">Datos de Faena</div>
          <div class="form-grid">
            <div class="form-group">
              <label for="edit-cargo">Cargo</label>
              <div class="input-wrapper">
                <i class="fa-solid fa-helmet-safety input-icon"></i>
                <input type="text" id="edit-cargo" name="cargo" placeholder="Ej: Operador Maquinaria" class="modern-input">
              </div>
            </div>
            <div class="form-group">
              <label for="edit-grupo">Asignar Grupo</label>
              <div class="select-wrapper">
                <select id="edit-grupo" name="grupo" class="modern-input">
                  <option value="" disabled>Seleccione...</option>
                  <option value="A">Grupo A</option>
                  <option value="B">Grupo B</option>
                  <option value="C">Grupo C</option>
                  <option value="D">Grupo D</option>
                  <option value="E">Grupo E</option>
                  <option value="F">Grupo F</option>
                  <option value="G">Grupo G</option>
                  <option value="H">Grupo H</option>
                  <option value="J">Grupo J (Lun‚ÄìJue)</option>
                  <option value="K">Grupo K (Mar‚ÄìVie)</option>
                </select>
                <i class="fa-solid fa-chevron-down select-arrow"></i>
              </div>
            </div>
          </div>
          <div class="modal-footer" style="margin-top:18px;display:flex;justify-content:flex-end;gap:12px">
            <button type="button" id="cancel-edit" class="btn-cancel">Cancelar</button>
            <button type="submit" class="btn-save"><i class="fa-solid fa-check"></i> Guardar Cambios</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- Modal agregar trabajador -->
  <div id="modal-agregar" class="modal">
    <div class="modal-content modal-card">
      <div class="modal-header">
        <h3 class="modal-title">
          <i class="fa-solid fa-user-plus highlight-icon"></i> Agregar Trabajador
        </h3>
      </div>

      <div class="modal-body">
        <form id="form-agregar">
          <div class="form-section-label">Informaci√≥n Personal</div>
          <div class="form-grid">
            <div class="form-group">
              <label for="nombre">Nombres</label>
              <div class="input-wrapper">
                <i class="fa-regular fa-user input-icon"></i>
                <input type="text" id="nombre" name="nombre" placeholder="Ej: Juan Andr√©s" class="modern-input" required>
              </div>
            </div>
            <div class="form-group">
              <label for="apellido">Apellidos</label>
              <input type="text" id="apellido" name="apellido" placeholder="Ej: P√©rez Gonz√°lez" class="modern-input plain" required>
            </div>

            <div class="form-group">
              <label for="rut">RUT <span class="info-text">(sin puntos)</span></label>
              <div class="input-wrapper">
                <i class="fa-solid fa-id-card input-icon"></i>
                <input type="text" id="rut" name="rut" placeholder="12345678-9" class="modern-input" required>
              </div>
            </div>

            <div class="form-group">
              <label for="telefono">Tel√©fono</label>
              <div class="phone-input-group">
                <span class="country-code">üá®üá± +56</span>
                <input type="tel" id="telefono" name="telefono" placeholder="9 1234 5678" class="modern-input" maxlength="9">
              </div>
            </div>

            <div class="form-group full-width">
              <label for="email">Correo Electr√≥nico</label>
              <div class="input-wrapper">
                <i class="fa-regular fa-envelope input-icon"></i>
                <input type="email" id="email" name="email" placeholder="nombre@correo.com" class="modern-input">
              </div>
            </div>
          </div>

          <div class="separator-line"></div>
          <div class="form-section-label">Datos de Faena</div>

          <div class="form-grid">
            <div class="form-group">
              <label for="cargo">Cargo</label>
              <div class="select-wrapper">
                <select id="cargo" name="cargo" class="modern-input">
                  <option value="" disabled selected>Seleccione un cargo...</option>
                </select>
                <i class="fa-solid fa-chevron-down select-arrow"></i>
              </div>
            </div>

            <div class="form-group">
              <label for="grupo">Asignar Grupo</label>
              <div class="select-wrapper">
                <select id="grupo" name="grupo" class="modern-input">
                  <option value="" disabled selected>Seleccione...</option>
                  <option value="A">Grupo A</option>
                  <option value="B">Grupo B</option>
                  <option value="C">Grupo C</option>
                  <option value="D">Grupo D</option>
                  <option value="E">Grupo E</option>
                  <option value="F">Grupo F</option>
                  <option value="G">Grupo G</option>
                  <option value="H">Grupo H</option>
                  <option value="J">Grupo J (Lun‚ÄìJue)</option>
                  <option value="K">Grupo K (Mar‚ÄìVie)</option>
                </select>
                <i class="fa-solid fa-chevron-down select-arrow"></i>
              </div>
            </div>
          </div>

          <div class="modal-footer" style="margin-top:18px;display:flex;justify-content:flex-end;gap:12px">
            <button type="button" id="cancel-add" class="btn-cancel">Cancelar</button>
            <button type="submit" class="btn-save"><i class="fa-solid fa-check"></i> Agregar Trabajador</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- Modal confirmaci√≥n (borrar) -->
  <div id="modal-confirm" class="modal">
    <div class="modal-content modal-confirm">
      <h3 id="confirm-title">Confirmar</h3>
      <p id="confirm-msg">¬øEliminar a este trabajador?</p>
      <div class="form-buttons">
        <button type="button" id="confirm-cancel" class="btn btn-secondary">Cancelar</button>
        <button type="button" id="confirm-ok" class="btn btn-danger">Borrar</button>
      </div>
    </div>
  </div>

  <!-- Modal resultado (agregar trabajador) -->
  <div id="modal-result" class="modal">
    <div class="modal-content">
      <h3 id="result-title">Resultado</h3>
      <p id="result-msg"></p>
      <div class="form-buttons">
        <button type="button" id="result-ok" class="btn btn-primary">OK</button>
      </div>
    </div>
  </div>

  <script type="module" src="gestionapp.js"></script>

  <!-- Modal Nuevo Cargo -->
  <div id="modal-nuevo-cargo" class="modal">
    <div class="modal-content" style="max-width: 450px;">
      <div class="modal-header">
        <h3 class="modal-title">Crear Nuevo Cargo</h3>
        <button type="button" class="modal-close" id="close-nuevo-cargo">&times;</button>
      </div>
      
      <div class="modal-body">
        <div class="form-group">
          <label for="nuevoNombreCargo">Nombre del Cargo</label>
          <div class="input-wrapper">
            <i class="fa-solid fa-helmet-safety input-icon"></i>
            <input type="text" id="nuevoNombreCargo" placeholder="Ej: Mec√°nico" class="modern-input" autocomplete="off">
          </div>
        </div>
      </div>

      <div class="modal-footer" style="margin-top: 18px; display: flex; justify-content: flex-end; gap: 12px;">
        <button type="button" id="cancel-nuevo-cargo" class="btn-cancel">Cancelar</button>
        <button type="button" id="guardar-nuevo-cargo" class="btn-save">
          <i class="fa-solid fa-check"></i> Guardar Cargo
        </button>
      </div>
    </div>
  </div>
</body>
</html>
